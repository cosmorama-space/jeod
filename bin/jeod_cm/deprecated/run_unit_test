#!/bin/bash
#
# run_unit_test : script to run all unit_tests under a directory 
#                 or to clean all the unit_tests if provided
#                 'clean' as a 2nd argument
#                 
#    Usage: run_unit_test [path_to_dir] [clean]

# temp variable to store cwd patd
cdir=`pwd`

path_name=${1:-$JEOD_HOME}

unit_dir=`find $path_name -name unit_tests` 


# Runninng unit tests under each unit_tests directory
for ii in $unit_dir; do
   cd $cdir
# cd to unit_tests directory
   cd $ii
   new_dir=`pwd`
   list_dir=`ls`
   echo
   for jj in $list_dir; do
      cd $new_dir
# if it's not a directory, ignore it
      [ ! -d $jj ] && continue
# cd into unit_test directory   
      [ ! -e $jj/makefile ] && continue
      cd $jj
      if [[ $2 == "clean" ]]; then
         [ ! -e test_program ] && cd - > /dev/null && continue
         echo -e "=========================================================================="
         echo -e "Cleaning unit_test ${ii#$JEOD_HOME/}/$jj ..."
         echo -e "==========================================================================\n"
         make clean >& /dev/null
         [ ! -e $jj/test_program ] && rm -f $jj/test_program 
      else
         [ -e test_program ] && rm -f test_program && continue
         echo -e "=========================================================================="
         echo -e "Running unit_test ${ii#$JEOD_HOME/}/$jj ..."
         echo -e "==========================================================================\n"
# do make build first
         make build >& /dev/null
         [ $? != 0 ] && echo -e "${ii#$JEOD_HOME/}/$jj failed to build ... " >> $JEOD_HOME/unit_error && cd - > /dev/null && continue
# then do make run
         make run >& /dev/null
         [ $? != 0 ] && echo -e "${ii#$JEOD_HOME/}/$jj failed to run ... " >> $JEOD_HOME/unit_error && cd - > /dev/null && continue
      fi
   done
done
