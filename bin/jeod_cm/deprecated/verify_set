#!/bin/bash
#
# verify_set : script to verify all SET_test/RUN_* by default or 
#              specific RUN_NAME given via argument to this script
#       Usage: verify_set <RUN_NAME>

cddir=`pwd`
rname=${1:-RUN_\*}
[ ! -d SET_test ] && { echo -e "No SET_test in ${cddir#$JEOD_HOME/} ..." >> $JEOD_HOME/verif_error; exit 5; }
runs=`find SET_test -name $rname`

# Verifying SET_test/RUN* to SET_test_val/RUN* only if data exist in SET_test/RUN*
for ii in $runs; do
   logfile=`find $ii -name log_\* | grep -v header | grep -v mem | grep -v log_frame | grep -v jobs`
   if [[ ${#logfile} == 0 ]]; then 
# if no logfiles to compare, check if there are *.out files
      outfile=`find $ii -name \*.out`
      if [[ ${#outfile} == 0 ]]; then
         echo -e "\nERROR: RUN ${cddir#$JEOD_HOME/}/$ii has NO data ... \n"
         continue
      else
         runfiles=$outfile
      fi
   else
      runfiles=$logfile
   fi
      
   [ ! -d ${ii/#SET_test/SET_test_val} ] && {
      echo "No Validation data in ${cddir#$JEOD_HOME}/${ii/#SET_test/SET_test_val} ..." >> $JEOD_HOME/verif_error
      continue
      }
   for jj in $runfiles; do
      if [[ -e ${jj/#SET_test/SET_test_val} ]]; then
         diff -q $jj ${jj/#SET_test/SET_test_val} >& /dev/null || {
            echo "Result for ${cddir#$JEOD_HOME/}/${jj/#SET_test/SET_test_val} does not match ..." >> $JEOD_HOME/verif_error
            }
      else 
         echo "Needed ${cddir#$JEOD_HOME/}/${jj/#SET_test/SET_test_val} ..." >> $JEOD_HOME/verif_error
      fi
   done
done
